# Flipscreen Reader v1 (Black-white timing)

Program to read out and log output from the Flipscreen device (FGB TO3 VU Amsterdam). The Flipscreen device is an amplified photodiode powered by a microcontroller connected via serial port. 

This repository focuses on the software, instructions on how to install the device can be found in this readme under the section Driver Installation.

## Photodiode
The photodiode registeres time between exposure to dark and light, determined by a set threshold. When used in combination with a program that flips the screen from black to white or vice versa (a clear distinction between light and dark) this yields time intervals accurate up to a tenth of a millisecond. Keep in mind, when brightness of the screen is set too low, no distinction between light and dark can be made.

## Trigger input
The microcontroller can receive triggers on one of its pins in order to record. The device has a built in parallel printer connector which interfaces with a Biosemi Trigger Interface Serial to Parallel emulator. This is to remain as close to the EEG set-up used in our lab when testing trigger time to actual screen flip.

## Running the reader scripts
The scripts are written in python and simply read out the serial port. Statistics are still to be added. A requirements file is included to set up a proper environment for the script to run in.
Currently, only windows is supported.

### Setting up the environment
1. In your terminal, while inside the root of this project run the following:
`python -m venv env`

2. Then activate that environment in your terminal by running any of the three following scripts
For Powershell:
`.\env\Scripts\Activate.ps1`

For CMD
`.\env\Scripts\activate.bat`

For bash
`.\env\Scripts\activate`

3. Once determined that the environment started properly (name of the environment is prepended to your prompt e.g. (env)), install the requirements using:
`python -m pip install -r requirements.txt`


### Testing with read-serial and triggertest.py
To simply view timing between flips from black to white, run read-serial.py while in your environment:
`python read-serial.py`
This will return unfiltered Flipscreen serial output.


To view the timing from a sent trigger to a subsequent flip of the screen, run trigger-to-flip.py while in your environment:
`python trigger-to-flip.py`
This script filters Flipscreen serial output and only returns the value of interest.

Note that `read-serial.py` can also be used for the above. If an argument is passed to it, it will filter the output to only include output containing th provided argument:
`python read-serial.py rB2rA`

### Trigger info
The device is set to receive a trigger in the form of a byte written to it with value 1 in little endian. Or 'a' in uint8.

The times returned by the device are comparisons between 2 signals it reads from:
**Signal A**: The high- or low light state as detected by the photodiode. 
**Signal B**: The trigger pulse generated by the Biosemi Trigger Interface (8ms duration block pulse)

Both signals are theoretically perfect block waves each with a **Rising** and **Falling** flank, but in practice their flanks have a curved or dampened shape.
When determining timing, the most useful comparison is the time difference between the onset of the trigger and the onset of high light intensity, that is the rising flank of signal B and the rising flank of signal A. The naming for this is **rB2rA**. The device will put out many time comparisons of rising and falling flanks between A and B other than rB2rA, should you find those interesting to analyse.


## Test suite: Running accompanying Black-White or Trigger tests
The subfolders of this repository contain tests written in python and matlab, comprising the common ways experiments are performed in the Brain and Behaviour Lab of the FGB. The tests for OpenSesame and Matlab are currently ongoing. Tests for Psychopy GUI and CLI still need to be started. 

### Matlab - PsychToolBox
The `matlab-ptb/` folder contains tests with the suggested way to perform screen flips with PsychToolBox. For testing purposes, three variants are available: 
- crude: the most bare (poor way) of flipping 
- waitframes: common method to time the flipping in between completed screen writes (inter-frame-intervals, about 4ms for 240hz). 
- drawingfinished: the analogue to "wait for blanking" or "V-Sync" built in to PschToolBox. This is suggested to properly prepare frames before flippiong to them, while also executing code in between.

Each of these have a script that does either simple continuous flipping between black and white, or waits on a black frame, to then send a trigger pulse immediately before flipping to white.

### Opensesame
Much like the above, BlackWhite.osexp can be used to flip the screen from black to white, and FlipWithTrigger.osexp can be used to send a trigger pulse immediately before flipping to white from a black state.

Of concern when working with opensesame is to keep in mind the back-end that is used. Psychopy is the most commonly used, and most robust from our tests. The accomopanying back-end setting 'waitForBlanking' can be set to 'yes' or 'no', and can have a big impact. Also of note is a setting called useFBO. This is set in the **Window** class that Psychopy uses to draw. by default it is set to false, boith in the code, and when used by OpenSesame. Check for this by printing out the class attribute `window.useFBO`.

### Psychopy GUI
The GUI program of Psychopy. Still needs a proper test.

### Psychopy CLI
Using the psychopy package in python cli code, or using an Anaconda environment with the psychopy package for example. Still needs a proper test.


## Windows settings
When performing your tests, be wary of system settings and connected hardware on your PC. 
Common pitfalls:
- Display settings. For example Overdrive can influence pixel performance. sRGB is a useful setting, but is too dim.
- Multiple displays, and their mode (extend/duplicate). Seemingly windows automatically forces V-Sync when in these modes.
- When using multiple displays, ensure their monitor settings are identical or near identical.
- Screen refresh rate setting (note if the monitors don't have the exact same refresh rate)
- Nvidia or other GPU driver settings, importantly V-Sync. Having it always On seems to be good.

## Driver installation
The Flipscreen requires the microcontroller's driver to be installed before it will be detected by Windows. To do so, get the driver by searching for:
 - `CP210x_Universal_Windows_Driver`
Or by navigating to:
 - [https://www.silabs.com/software-and-tools/usb-to-uart-bridge-vcp-drivers?tab=downloads](https://www.silabs.com/software-and-tools/usb-to-uart-bridge-vcp-drivers?tab=downloads)

The latest universal windows driver will suffice. Download and extract this to a convenient path (e.g. Downloads or Desktop)

Installation of the driver has to be done manually. 
1. Ensure you've downloaded and extracted the driver to a convenient path
2. Connect the device's USB to the PC
3. Find the device in the windows Device Manager
  a. Should be visible under the LTP/COM devices. A device with a warning symbol and titled like CP210x
  b. Right click on the device and open the properties window.
  c. Find the "Update or install the driver" option and start the wizard.
  d. When prompted, choose the "Find driver on this computer" option.
  e. Navigate to the driver folder that we just extracted. No need to choose any subfolder in there, just the main extracted folder.
  f. Continue, wait until the wizard has finished the installation.
  g. You'll notice the driver has succesfully installed when the Device Manager window refreshes itsekf and shows the device with a proper name and without warning symbol.
4. Remove the downloaded driver / extracted driver folders.

The Flipscreen doesn't need to be reconnected. It now should have obtained a valid COM identifier, and will be recognized by this PC in the future.


